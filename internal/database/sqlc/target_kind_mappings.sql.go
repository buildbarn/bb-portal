// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: target_kind_mappings.sql

package sqlc

import (
	"context"
	"database/sql"

	"github.com/lib/pq"
)

const createTargetKindMappingsBulk = `-- name: CreateTargetKindMappingsBulk :exec
INSERT INTO target_kind_mappings (
    bazel_invocation_id,
    target_id,
    start_time_in_ms
)
SELECT
    $1,
    target_id,
    NULLIF(start_time, 0)
FROM (
    SELECT 
        unnest($2::bigint[]) AS target_id,
        unnest($3::bigint[]) AS start_time
) AS input
`

type CreateTargetKindMappingsBulkParams struct {
	BazelInvocationID int64
	TargetIds         []int64
	StartTimes        []int64
}

func (q *Queries) CreateTargetKindMappingsBulk(ctx context.Context, arg CreateTargetKindMappingsBulkParams) error {
	_, err := q.db.ExecContext(ctx, createTargetKindMappingsBulk, arg.BazelInvocationID, pq.Array(arg.TargetIds), pq.Array(arg.StartTimes))
	return err
}

const deleteTargetKindMappingsFromPages = `-- name: DeleteTargetKindMappingsFromPages :execrows
DELETE FROM target_kind_mappings m
USING bazel_invocations AS i
WHERE
    m.bazel_invocation_id = i.id
    AND m.ctid >= format('(%s,0)', $1::bigint)::tid
    AND m.ctid < format('(%s,0)', $1::bigint + $2::bigint)::tid
    AND i.bep_completed = true
`

type DeleteTargetKindMappingsFromPagesParams struct {
	FromPage int64
	Pages    int64
}

func (q *Queries) DeleteTargetKindMappingsFromPages(ctx context.Context, arg DeleteTargetKindMappingsFromPagesParams) (int64, error) {
	result, err := q.db.ExecContext(ctx, deleteTargetKindMappingsFromPages, arg.FromPage, arg.Pages)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected()
}

const findMappedTargets = `-- name: FindMappedTargets :many
SELECT 
    t.label, 
    t.aspect, 
    m.target_id, 
    m.start_time_in_ms
FROM (
    SELECT 
        unnest($1::text[]) AS label,
        unnest($2::text[]) AS aspect
) AS input
JOIN targets t ON 
    t.label = input.label AND 
    t.aspect = input.aspect
JOIN target_kind_mappings m ON
    m.target_id = t.id AND
    m.bazel_invocation_id = $3
`

type FindMappedTargetsParams struct {
	Labels            []string
	Aspects           []string
	BazelInvocationID int64
}

type FindMappedTargetsRow struct {
	Label         string
	Aspect        string
	TargetID      int64
	StartTimeInMs sql.NullInt64
}

func (q *Queries) FindMappedTargets(ctx context.Context, arg FindMappedTargetsParams) ([]FindMappedTargetsRow, error) {
	rows, err := q.db.QueryContext(ctx, findMappedTargets, pq.Array(arg.Labels), pq.Array(arg.Aspects), arg.BazelInvocationID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []FindMappedTargetsRow
	for rows.Next() {
		var i FindMappedTargetsRow
		if err := rows.Scan(
			&i.Label,
			&i.Aspect,
			&i.TargetID,
			&i.StartTimeInMs,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}
